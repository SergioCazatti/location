<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localizaci√≥n</title>
</head>

<body>
    <p><h2>Localizar dispositivo v.1.6</h2></p>
    <button id="descargar">Descargar</button>
    <button id="localizar">Iniciar</button>
    <button id="detener">Detener</button>
    <div id="info"></div>
</body>



<script>
    class trkpt {
        constructor(
            latitud,
            longitud,
            elevacion,
            tiempo,
        ){
            this.latitud = latitud;
            this.longitud = longitud;
            this.elevacion = elevacion;
            this.tiempo = tiempo;
        }
    };

    const posiciones = [];
    let contenidoArchivo = "";
    let identificador;
    let altitud = 0;
    
    let y = document.getElementById("info");

    const $botonLocalizar = document.querySelector("#localizar");
    $botonLocalizar.onclick = () => {
        if (navigator.geolocation) {
            alert("Tu navegador adimte la geolocalizaci&oacute;n");            
            identificador = setInterval(localizar,1000);
            //x.innerHTML = "Tu navegador adimte la geolocalizaci&oacute;n";

        }
        else { //x.innerHTML = "Tu navegador no soporta la geolocalizaci&oacute;n."; 
            alert("Tu navegador no soporta la geolocalizaci&oacute;n."); 
        } 
    }

    function localizar(){
        navigator.geolocation.getCurrentPosition(showPosition, showError);
    }

    function showPosition(posicion){
        if (posicion.coords.altitude) {
            altitud = posicion.coords.altitude;
        }
        else{
            altitud = 0;
        }

        console.log(posicion.coords.longitude.toString() +", "+ posicion.coords.latitude.toString() + ", " + altitud);

        //contenidoArchivo = contenidoArchivo.toString() + posicion.coords.longitude.toString() +", "+ posicion.coords.latitude.toString() + ", " + altitud.toString() + " \n";

        posiciones.push(new trkpt(posicion.coords.latitude, posicion.coords.longitude, altitud, posicion.timestamp));


        y.innerHTML = "Latitud: " + posicion.coords.latitude;
        y.innerHTML += "<br/>Longitud: " + posicion.coords.longitude;
        y.innerHTML += "<br/>Precisi&oacute;n: " + posicion.coords.accuracy;
        y.innerHTML += "<br/>Altidud: " + posicion.coords.altitude;
        y.innerHTML += "<br>Precisi&oacute;n de Altidud: " + posicion.coords.altitudeAccuracy;
        y.innerHTML += "<br>Heading: " + posicion.coords.heading;
        y.innerHTML += "<br>Velocidad: " + posicion.coords.speed;
        y.innerHTML += "<br>Fecha (en tiempo Unix): " + posicion.timestamp;
        
    }

    function showError(error){
/*         switch (error.code) {
            case error.PERMISSION_DENIED:
                x.innerHTML = "El usuario ha denegado el permiso a la localizaci&oacute;n."
                break;
            case error.POSITION_UNAVAILABLE:
                x.innerHTML = "La informaci&oacute;n de la localizaci&oacute;n no est&aacute; disponible."
                break;
            case error.TIMEOUT:
                x.innerHTML = "El tiempo de espera para buscar la localizaci&oacute;n ha expirado."
                break;
            case error.UNKNOWN_ERROR:
                x.innerHTML = "Ha ocurrido un error desconocido."
                break;
        }
 */    }


    const $botonDetener = document.querySelector("#detener");
    $botonDetener.onclick = () => {
        console.log(identificador);
        clearInterval(identificador);
        identificador = null;
        console.log(identificador);
    }


    const guardarArchivoDeTexto = (contenido, nombre) => {
        const a = document.createElement("a");
        const archivo = new Blob([contenido], { type: 'text/plain' });
        const url = URL.createObjectURL(archivo);
        a.href = url;
        a.download = nombre;
        a.click();
        URL.revokeObjectURL(url);
    }
    const $botonDescargar = document.querySelector("#descargar");
    $botonDescargar.onclick = () => {
/*         const lista = [];
        lista[0] = -60;
        lista[1] = -30;
        let variable1 = lista[0];
        let variable2 = lista[1];
        console.log(variable1.toString() + ", " + variable2.toString());
 */        //guardarArchivoDeTexto(variable1.toString() + " " +variable2.toString(), "archivoPlano.txt");

        //contenidoArchivo = posiciones.join("\n");

        console.log("lat: " + posiciones[1].latitud);
        console.log("lon: " + posiciones[1].longitud);
        console.log("elevacion: " + posiciones[1].elevacion);
        console.log("tiempo: " + posiciones[1].tiempo);

        const fecha = new Date();
        const hoy = fecha.toISOString();
        
        contenidoArchivo = '<?xml version="1.0" encoding="UTF-8"?><gpx creator="sfc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd" version="1.1" xmlns="http://www.topografix.com/GPX/1/1"> <metadata>  <time>' + hoy + '</time> </metadata> <trk>  <name>Nombre</name>  <type>4</type>  <trkseg>\n'

        posiciones.forEach( (point) =>{
          contenidoArchivo = contenidoArchivo.toString() + '<trkpt lat="' + point.latitud +'" lon="' + point.longitud + '"><ele>' + point.elevacion + '</ele><time>'+ point.tiempo +'</time></trkpt>\n';
        })
        
        contenidoArchivo = contenidoArchivo + "\n</trkseg> </trk></gpx>"

        guardarArchivoDeTexto(contenidoArchivo, "archivoPlano2.txt");
    }




</script>

</html>